name: Backend CI

on:
  push:
    branches:
      - main
      - docker-main
  pull_request:
    branches:
      - main
      - docker-main

jobs:
  backend-setup:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, macos-latest, ubuntu-latest]
        python-version: ["3.10"]

    steps:
      # Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # Install system dependencies for Linux/macOS
      - name: Install system dependencies
        if: runner.os != 'Windows'
        run: |
          if [[ "${RUNNER_OS}" == "Linux" ]]; then
            sudo apt-get update
            sudo apt-get install -y portaudio19-dev
          elif [[ "${RUNNER_OS}" == "macOS" ]]; then
            brew update
            brew install portaudio
          fi
        shell: bash

      # Ensure pip cache directory exists
      - name: Ensure pip cache directory exists
        if: runner.os != 'Windows'
        run: mkdir -p ~/.cache/pip

      # Cache pip dependencies
      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ matrix.python-version }}-

      # Setup Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      # Install Python dependencies
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt

      # Lint backend code
      - name: Lint backend code
        run: |
          python -m pip install flake8
          flake8 backend/ --max-line-length 160 --ignore E127,E251,E302,E501,E261,E262,E265,F401,F403,F405,F841,W293,E128,E303,E305,W292,E122,W391,E111,E117,E301,E125,E222,E226,E201,E203,E202,E721,W503,W504,E272,E126,E225,W291,E211,E231,E722,W191,E712,F523,E402,E306

      # Format backend code with Black
      - name: Format backend code with Black
        run: |
          python -m pip install black
          black backend/

      # Perform Dependency Audit (safety scan)
      - name: Perform Dependency Audit
        run: |
          python -m pip install safety
          safety scan -r backend/requirements.txt
